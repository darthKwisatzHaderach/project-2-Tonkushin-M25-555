# Primitive DB

## Управление таблицами

### Доступные команды

- `create_table <имя_таблицы> <столбец1:тип> <столбец2:тип> ...` — создать таблицу. Автоматически добавляется столбец `ID:int` в начало списка столбцов. Поддерживаемые типы: `int`, `str`, `bool`.
- `list_tables` — показать список всех таблиц и их структуру.
- `drop_table <имя_таблицы>` — удалить таблицу.
- `help` — вывести справочную информацию.
- `exit` или `quit` — выйти из программы.

## CRUD-операции

### INSERT - Добавление записей

- `insert into <имя_таблицы> values (<значение1>, <значение2>, ...)` — добавить новую запись в таблицу. ID генерируется автоматически.

**Пример:**
```bash
insert into users values ("Иван", "ivan@mail.ru", 30, true)
```

### SELECT - Чтение записей

- `select from <имя_таблицы>` — получить все записи из таблицы.
- `select from <имя_таблицы> where <столбец> = <значение>` — получить записи, соответствующие условию.

**Примеры:**
```bash
select from users
select from users where age = 30
select from users where name = "Иван"
```

Результаты выводятся в виде красивой таблицы с использованием `prettytable`.

### UPDATE - Обновление записей

- `update <имя_таблицы> set <столбец> = <новое_значение> where <столбец_условия> = <значение_условия>` — обновить записи, соответствующие условию.

**Пример:**
```bash
update users set active = false where name = "Иван"
update users set age = 31 where email = "ivan@mail.ru"
```

### DELETE - Удаление записей

- `delete from <имя_таблицы> where <столбец> = <значение>` — удалить записи, соответствующие условию.

**Пример:**
```bash
delete from users where age = 30
delete from users where name = "Иван"
```

**Важно:** Строковые значения в командах должны быть заключены в кавычки (одинарные или двойные).

## Продвинутые возможности

### Декораторы и обработка ошибок

Проект использует декораторы для улучшения качества кода:

1. **Централизованная обработка ошибок** — декоратор `@handle_db_errors` автоматически перехватывает и обрабатывает типичные ошибки базы данных (FileNotFoundError, KeyError, ValueError).

2. **Подтверждение опасных операций** — декоратор `@confirm_action` запрашивает подтверждение перед выполнением опасных действий:
   - При удалении таблицы (`drop_table`)
   - При удалении записей (`delete`)
   
   Пример:
   ```
   Введите команду:  drop_table books
   Вы уверены, что хотите выполнить "удаление таблицы"? [y/n]: y
   Таблица 'books' удалена.
   ```

3. **Логирование времени выполнения** — декоратор `@log_time` измеряет и выводит время выполнения операций:
   - Применяется к операциям `insert` и `select`
   - Выводит время в формате: `Функция insert выполнилась за 0.023 секунд`

4. **Кэширование результатов** — функция `create_cacher()` создает кэш с замыканием:
   - Результаты `select` кэшируются для ускорения повторных запросов
   - Кэш автоматически очищается при изменении данных (insert, update, delete)
   - Выводит информацию о попаданиях/промахах кэша

### Настройка путей

Пути к файлам метаданных и данных таблиц задаются в `pyproject.toml`:

```toml
[tool.primitive_db]
metadata_path = "src/primitive_db/db_meta.json"
data_dir = "data"
```

Также можно использовать переменную окружения:
```bash
export PRIMITIVE_DB_PROJECT_ROOT=/path/to/project
database
```

### Пример использования

```bash
$ database
***Процесс работы с таблицей***

Функции:
  create_table <имя_таблицы> <столбец1:тип> [<столбецN:тип>] - создать таблицу
  list_tables - показать список всех таблиц
  drop_table <имя_таблицы> - удалить таблицу
  insert into <имя_таблицы> values (<значение1>, <значение2>, ...) - создать запись
  select from <имя_таблицы> [where <столбец> = <значение>] - прочитать записи
  update <имя_таблицы> set <столбец> = <значение> where <столбец> = <значение> - обновить запись
  delete from <имя_таблицы> where <столбец> = <значение> - удалить запись
  help - справочная информация
  exit - выйти из программы

Введите команду:  create_table users name:str email:str age:int active:bool
Таблица 'users' создана.
Введите команду:  insert into users values ("Иван", "ivan@mail.ru", 30, true)
Запись добавлена в таблицу 'users'.
Введите команду:  insert into users values ("Мария", "maria@mail.ru", 25, true)
Запись добавлена в таблицу 'users'.
Введите команду:  select from users
+----+-------+---------------+-----+--------+
| ID | name  |     email     | age | active |
+----+-------+---------------+-----+--------+
|  1 | Иван  | ivan@mail.ru  |  30 |  True  |
|  2 | Мария | maria@mail.ru |  25 |  True  |
+----+-------+---------------+-----+--------+
Введите команду:  select from users where age = 30
+----+------+--------------+-----+--------+
| ID | name |     email    | age | active |
+----+------+--------------+-----+--------+
|  1 | Иван | ivan@mail.ru |  30 |  True  |
+----+------+--------------+-----+--------+
Введите команду:  update users set active = false where name = "Иван"
Записи обновлены в таблице 'users'.
Введите команду:  delete from users where age = 25
Вы уверены, что хотите выполнить "удаление записей"? [y/n]: y
[CACHE] Кэш очищен
Записи удалены из таблицы 'users'.
Функция delete выполнилась за 0.001 секунд
Введите команду:  drop_table test_table
Вы уверены, что хотите выполнить "удаление таблицы"? [y/n]: n
Удаление таблицы отменено.
Введите команду:  exit
```

## Установка и запуск

### Установка зависимостей

```bash
make install
```

### Запуск программы

```bash
make project
# или
poetry run database
# или (если пакет установлен)
database
```

### Сборка и установка пакета

```bash
make build
make package-install
```

### Демонстрация работы

[![asciicast](https://asciinema.org/a/fnZhgHZaRNUf2PCIQrSa35owl.svg)](https://asciinema.org/a/fnZhgHZaRNUf2PCIQrSa35owl)

*Для просмотра локальной записи: `asciinema play docs/demo.cast`.*
